% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/resample_covariates_and_observations.R
\name{resample_covariates_and_observations}
\alias{resample_covariates_and_observations}
\title{Spatially resample the covariates and observations resources
Spatially Resample Covariates and Observations Across Spatial Scales}
\usage{
resample_covariates_and_observations(
  covs,
  obs,
  individuals,
  mode_cols_covs,
  obs_covs
)
}
\arguments{
\item{covs}{A data frame or tibble of covariate data from a camtrapDP formatted frictionless data package, which can be accessed from the \code{WildObsR::wildobs_dp_download()} function. It must include columns defining spatial cells (with names starting with "cellID"), and date-time columns (e.g., \code{deploymentStart} and \code{deploymentEnd}) formatted as POSIXct.}

\item{obs}{A data frame or tibble of observation data from a camtrapDP formatted frictionless data package, which can be accessed from the \code{WildObsR::wildobs_dp_download()} function. It must include a \code{deploymentID} column and several date-time columns (e.g., \code{eventStart}, \code{eventEnd}, \code{classificationTimestamp}, \code{observationStart}, \code{observationEnd}) formatted as POSIXct.}

\item{individuals}{A character string specifying how to aggregate the number of individuals counted per spatially re sampled cell per day. Options are \code{"sum"} to take the sum total number of counts or  \code{"max"} to use the maximum count.}

\item{mode_cols_covs}{(Optional) A character vector specifying the names of covariate columns for which the mode should be computed rather than concatenating all unique values. (Example: \code{c("habitat")}).}

\item{obs_covs}{(Optional) A character vector specifying observation-level covariate column names that may vary in space and time and will be combined with the resampled observations. (Example: \code{c("baitUse", "featureType")}).}
}
\value{
A nested list with two elements:
\describe{
\item{\code{spatially_resampled_observations}}{A list of data frames corresponding to different spatial scales (e.g., "cellID_1km", "cellID_10km") containing all resampled observation data.}
\item{\code{spatially_resampled_covariates}}{A list of data frames corresponding to different spatial scales containing all resampled covariate data.}
}
}
\description{
This function resamples covariate and observation data across spatial scales generated from the \code{WildObsR::spatial_hexagon_generator()} function. It validates the input data by ensuring that all necessary spatial, temporal, and deployment identifiers are present and correctly formatted. Numeric covariates are aggregated using means, while categorical covariates are combined by concatenating unique values.

In addition, the function computes several key metrics:
\itemize{
\item Sampling effort per spatial unit (trap-nights),
\item Resampled start and end dates for each sampling unit.
}
Users can optionally specify which covariate columns should be aggregated using the mode (i.e., the most frequent value) instead of concatenation, and which covariate variables that vary in space and time (i.e., observation covariates) should be incorporated into the resampled observations. Example values provided in the documentation
(\code{c("habitat")} for mode aggregation and \code{c("baitUse", "featureType")} for observation covariates) serve as examples that work with any camtrap DP formatted data.

The function generates new columns in the output data as follows:

\strong{Resampled Covariates} include:
\describe{
\item{\code{deploymentsIncluded}}{A concatenated string of \code{deploymentID} values representing all deployments included within each spatial cell.}
\item{\code{cellEffort}}{The total sampling effort per cell, calculated as trap-nights (i.e., the number of active deployments times the duration they were active, in days).}
\item{\code{samplingStart}}{The earliest \code{deploymentStart} date-time among the deployments in a cell, marking the beginning of the sampling period per cellID.}
\item{\code{samplingEnd}}{The latest \code{deploymentEnd} date-time among the deployments in a cell, marking the end of the sampling period per cellID.}
}

\strong{Resampled Observations} include:
\describe{
\item{\code{deploymentsActiveAtDate}}{A concatenated string of \code{deploymentID} values that were active in a given resampled cellID on each day.}
\item{\code{numberDeploymentsActiveAtDate}}{The number of deployments active in a given resampled cell on each day.}
\item{\code{independentEvents}}{The total count of unique \code{eventID} values per cell per day per species, representing independent events.}
\item{\code{independentObservations}}{The total count of unique \code{observationID} values per cell per day per species.}
\item{\code{totalIndividuals}}{The aggregated count of individuals per cell per day per species, computed based on the \code{individuals} parameter (either by summing counts or taking the maximum value).}
}
}
\details{
The function performs the following steps to resample the covariate and observation data:
\enumerate{
\item \strong{Data Validation}:
\itemize{
\item Verifies that the covariates data frame contains at least one spatial cellID column generated from the \code{WildObsR::spatial_hexagon_generator()} function (i.e., a column whose name starts with "cellID"). If not, the function stops with an error.
\item Checks that the \code{deploymentID} values match between the covariates and observation data. If there is a mismatch, the function stops with an error.
\item Ensures that the specified observation-level covariate columns (provided in \code{obs_covs}) exist in the covariates data. If some are missing, they are omitted from further processing with a warning.
\item Confirms that all required date-time columns in both datasets are formatted as \code{POSIXct}. This includes columns such as \code{eventStart}, \code{eventEnd}, \code{classificationTimestamp}, \code{observationStart}, and \code{observationEnd} in the observations, and \code{deploymentStart} and \code{deploymentEnd} in the covariates.
}
\item \strong{Data Preparation}:
\itemize{
\item Removes any columns that contain only \code{NA} values from both datasets.
\item For the covariates:
\itemize{
\item Extracts character columns (excluding those that will be processed by mode aggregation) and numeric columns that will be averaged.
\item Adds sequential Julian date values derived from \code{deploymentStart} and \code{deploymentEnd} to standardize the temporal resolution. These columns are removed before returning the final datasets.
}
\item For the observations:
\itemize{
\item Extracts date-time columns (identified by the \code{POSIXct} class), character/factor columns, and numeric columns (excluding those with names like "deltaTime" or "count").
\item Computes a sequential Julian date from \code{eventStart} to serve as the daily resolution for resampling. This column is removed before returning the final datasets.
}
}
\item \strong{Resampling by Deployment Group and Spatial Scale}:
\itemize{
\item The function loops over each unique deployment group present in the covariates data. This speeds up the process.
\item For each deployment group:
\itemize{
\item Subsets the covariates and observations to include only the relevant deployments.
\item Merges spatial cell information (i.e., the \code{cellID} columns) from the covariates into the observations based on the \code{deploymentID}.
}
}
\item \strong{Resampling of Covariates}:
\itemize{
\item Within each deployment group, the function iterates over each spatial scale (columns containing "cellID_").
\item For each spatial scale, it loops through each unique sampling unit (i.e., each unique cell value):
\itemize{
\item A new row is created for each sampling unit, starting as an empty data frame with the same structure as the covariates data.
\item Numeric covariate values are aggregated by computing the mean (or left as \code{NA} if all values are missing). The column names are updated to indicate that these are averaged values (e.g., \code{"Avg_<column>"}).
\item Sampling effort is calculated as the total active duration (in days) summed over all unique deployments in the cell.
\item The sampling period is defined by the minimum \code{deploymentStart} (as \code{samplingStart}) and maximum \code{deploymentEnd} (as \code{samplingEnd}) for the cell.
\item Character variables are processed by pasting together sorted unique values.
\item For any covariate specified in \code{mode_cols_covs}, the function calculates the mode (i.e., the most frequent value) instead of concatenating all values.
\item Spatial information is preserved by keeping the cell identifier and any associated polygon geometry.
}
}
\item \strong{Resampling of Observations}:
\itemize{
\item For each spatial scale, the function further processes the observations by iterating over each sampling unit, each day (based on the sequential Julian date), and each species (\code{scientificName}).
\item For each combination:
\itemize{
\item The function merges relevant observation-level covariate information from the covariates dataset.
\item Date-time columns are aggregated: start times are set to the minimum value and end times to the maximum.
\item Active deployment information is compiled, including a concatenated list of active deployments and the count of these deployments.
\item Event-level metrics are computed, such as the number of unique events and observations.
\item Individual counts are aggregated according to the user-specified method (either \code{"sum"} or \code{"max"}).
\item Species-level variables are aggregated by concatenating sorted unique values.
\item Numeric observation columns are averaged.
}
}
\item \strong{Compilation of Resampled Data}:
\itemize{
\item After processing all deployment groups and spatial scales, a final verification is implemented to ensure all cellID values are present and matching in the resampled covariates and observations.
\item Finally, the function assembles the resampled data into two nested lists:
\itemize{
\item One list contains the resampled covariates, organized by spatial scale.
\item The other list contains the resampled observations, also organized by spatial scale.
}
}
\item \strong{Output}:
\itemize{
\item The function returns a single list with two elements:
\itemize{
\item \code{"spatially resampled observations"}: a nested list of data frames for each spatial scale.
\item \code{"spatially resampled covariates"}: a nested list of data frames for each spatial scale.
}
}
}
}
\examples{
\dontrun{
# Example usage with pre-processed camera trap data, accessed from WildObs:

# Load the general use WildObs API key
api_key <- "f4b9126e87c44da98c0d1e29a671bb4ff39adcc65c8b92a0e7f4317a2b95de83"

# use WildObsR function to access data
dp <- WildObsR::wildobs_dp_download(api_key = api_key, project_ids = "ZAmir_QLD_Wet_Tropics_2022_WildObsID_0001")
# extract first DP from the list
dp <- dp[[1]]

# Extract resources from the data package
covs <- frictionless::read_resource(dp, "covariates")
obs  <- frictionless::read_resource(dp, "observations")
deps <- frictionless::read_resource(dp, "deployments")

# Assign spatial scales
# 'scales' defines the area (in square meters) covered by the hexagonal cell
scales <- c(1000000, 3000000)

# Add data source to the covariates
covs$source <- dp$contributors[[1]]$tag

# Generate spatial hexagons based on the provided scales
covs <- WildObsR::spatial_hexagon_generator(covs, scales)
# Identify matching columns between deployments and covariates
cols <- names(deps)[names(deps) \%in\% names(covs)]
# Merge deployment information to the covariates
covs <- merge(deps, covs, by = cols)  # Note: This overwrites the original covs data
# Define columns for mode aggregation (example: 'source' and 'habitat')
mode_cols_covs <- names(covs)[grepl("source|habitat", names(covs))]
# Set the method for aggregating the total number of individuals detected:
individuals <- "sum"  # Alternative: "max"
# Specify observation-level covariate variables derived from deployments.
# These variables capture information that varies in space and time.
obs_covs <- c("baitUse", "featureType", "setupBy", "cameraModel", "cameraDelay","cameraHeight", "cameraDepth", "cameraTilt", "cameraHeading", "detectionDistance", "deploymentTags")

# now spatially resample the data, noting that this function may take a few minutes to run
resamp_data = WildObsR::resample_covariates_and_observations(covs, obs, individuals = "sum", mode_cols_covs, obs_covs)

# Select the resampled observations and covs at the 1 km scale
resamp_obs = resamp_data$spatially_resampled_observations$cellID_1km
resamp_covs = resamp_data$spatially_resampled_covariates$cellID_1km
}

}
\author{
Zachary Amir
}
