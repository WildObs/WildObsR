% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/matrix_generator.R
\name{matrix_generator}
\alias{matrix_generator}
\title{Generate Detection History and Covariate Matrices from camtrapDP Formatted Data}
\usage{
matrix_generator(
  obs,
  covs,
  dur,
  w,
  site_covs,
  obs_covs,
  all_locationNames,
  scientificNames,
  type,
  individuals,
  group_sp = NULL
)
}
\arguments{
\item{obs}{A \code{data.frame} of observations. This must include columns for date-time information
(e.g., \code{eventStart}, \code{eventEnd}, \code{observationStart}, \code{observationEnd}),
a species identifier (\code{scientificName}), and a unique identifier for sampling units
(e.g., \code{cellID_10km} in spatially resampled data from \code{WildObsR::resample_covariates_and_observations()} or \code{deploymentID} in regular camtrap DP data).}

\item{covs}{A \code{data.frame} of covariates. This must include sampling start/end dates (e.g.,
\code{samplingStart}, \code{samplingEnd} in spatially resampled data from \code{WildObsR::resample_covariates_and_observations()} or \code{deploymentStart}, \code{deploymentEnd} in regular camtrap DP data), spatial identifiers (matching \code{obs}), and additional site-level covariate columns.}

\item{dur}{A numeric value indicating the maximum sampling duration (in days) where a population is assumed to be closed to changes in size.}

\item{w}{A numeric value specifying the length (in days) of each sampling occasion window that is used to compress the detection history matrix to improve model performance by increasing detection probability.}

\item{site_covs}{A character vector of column names in \code{covs} to be used as site-level covariates.}

\item{obs_covs}{A character vector of column names in \code{obs} to be used as observation-level covariates.}

\item{all_locationNames}{A logical indicating whether all locationName values should be included (\code{TRUE})
or only locationNames with species detections (\code{FALSE}) should be included.}

\item{scientificNames}{A character vector of species names to generate matrices for. Each species
will be processed separately.}

\item{type}{A character string indicating the type of model. Use \code{"abundance"} to generate a count history matrix using count data
or \code{"occupancy"} to generate a detection history matrix using presence/absence data.}

\item{individuals}{A character string specifying the method for aggregating individual counts used in the count history matrix.
Use \code{"sum"} to sum detections across occasions or \code{"max"} to take the maximum value.}

\item{group_sp}{Optional character string indicating which species should be grouped to a group-size of one. If provided (e.g., "scientificName"), cells in count matrix will be grouped to one, but will still get aggregated when shrinking the sampling occasion window \code{"w"}. Default is NULL.}
}
\value{
A named \code{list} where each element corresponds to a species. Each element is itself a
list with the following components:
\describe{
\item{\code{detection_matrix}}{A matrix of detection (or count) data with rows representing
sampling units and columns representing sampling occasion windows.}
\item{\code{site_level_covariates}}{A \code{data.frame} of site-level covariates used in the analysis.}
\item{\code{observation_level_covariates}}{A \code{list} of matrices containing observation-level covariate, where each matrix is aligned with the detection history matrix.}
}
}
\description{
This function processes camera trapping data formatted using the camtrapDP data standard to generate detection history matrices along with site-level and observation-level covariate matrices. These outputs can then be used for hierarchical occupancy or abundance modeling (e.g., with the \code{unmarked} package).
}
\details{
The function performs several key steps:

\enumerate{
\item \strong{Data Validation:} Checks are performed to ensure that:
\itemize{
\item The identifier column (e.g., \code{cellID} or \code{deploymentID}) is consistent across
\code{obs} and \code{covs}.
\item Specified site-level and observation-level covariate columns are present and contain no NA values.
\item Date-time columns in both \code{obs} and \code{covs} are properly formatted as \code{POSIXct}.
\item The provided species names (\code{scientificNames}) exist in the \code{obs} table.
}
\item \strong{Timezone Adjustment:} Date-time values are updated to the appropriate timezone based on
the mean latitude and longitude of the sites using \code{lutz::tz_lookup_coords} and \code{lubridate::with_tz}.
\item \strong{Date Sequence and Sampling Occasions:} A complete sequence of dates is generated for each
sampling unit and an index is assigned to each sampling occasion.
\item \strong{Matrix Generation:} For each species, a detection history matrix is created by aligning
observations to their respective sampling occasions. The matrix can contain either count data (for
abundance models) or binary presence/absence data (for occupancy models).
\item \strong{Observation-level Covariate Formatting:} Observation covariates are organized into matrices
that align with the detection history matrix and are compressed to match sampling occasion windows.
}

@examples
\dontrun{
# Example usage with pre-processed camera trap data:
dp <- WildObsR::wildobs_dp_download("ZAmir_QLD_Wet_Tropics_2022_WildObsID_0001")

# Extract resources from the data package
covs <- frictionless::read_resource(dp, "covariates")
obs  <- frictionless::read_resource(dp, "observations")
deps <- frictionless::read_resource(dp, "deployments")

## Assign spatial scales
'scales' defines the apothem (in meters) of the hexagonal cell, where the names (e.g., "1km", "10km") refer to the area covered by the cell.
scales <- c("1km" = 1074.6, "10km" = 3398)

## Add data source to the covariates
covs$source <- dp$contributors[[1]]$tag

## Generate spatial hexagons based on the provided scales
covs <- WildObsR::spatial_hexagon_generator(covs, scales)
# Identify matching columns between deployments and covariates
cols <- names(deps)[names(deps) %in% names(covs)]
# Merge deployment information to the covariates
covs <- merge(deps, covs, by = cols)  # Note: This overwrites the original covs data
## Define columns for mode aggregation (example: 'source' and 'habitat')
mode_cols_covs <- names(covs)[grepl("source|habitat", names(covs))]
## Set the method for aggregating the total number of individuals detected:
individuals <- "sum"  # Alternative: "max"
## Specify observation-level covariate variables derived from deployments.
# These variables capture information that varies in space and time.
obs_covs <- c("baitUse", "featureType", "setupBy", "cameraModel", "cameraDelay","cameraHeight", "cameraDepth", "cameraTilt", "cameraHeading", "detectionDistance", "deploymentTags")

### now spatially resample the data
resamp_data = resample_covariates_and_observations(covs, obs, individuals = "sum", mode_cols_covs, obs_covs) # this function may take a few minutes to run

## Select the resampled observations and covs @ the 10 km scale
resamp_obs = resamp_data$spatially_resampled_observations$cellID_10km
resamp_covs = resamp_data$spatially_resampled_covariates$cellID_10km

## Run the matrix generator function
res <- matrix_generator(
  obs = resamp_obs,
  covs = resamp_covs,
  dur = 110,
  w = 3,
  site_covs = c("mode_habitat", "Avg_human_footprint_10km2", "locationName", "Avg_FLII_3km2"),
  obs_covs = c("numberDeploymentsActiveAtDate", "cameraHeight", "featureType", "cameraModel"),
  all_locationNames = TRUE,
  scientificNames = c("Hypsiprymnodon moschatus", "Orthonyx spaldingii", "Uromys caudimaculatus"),
  type = "abundance",
  individuals = "sum"
)

# Access the detection matrix for one species:
res[["Hypsiprymnodon_moschatus"]][["detection_matrix"]]
}
}
\author{
Zachary Amir
}
